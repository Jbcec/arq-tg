const projectsData = {
    social: [
        {
            name: 'ANCHO',
            location: 'Madrid',
            images: [
                'images/social/ancho/1.jpg',
            ],
            category: 'Arquitectura Gastronomica',
            area: '130 m²',
            year: '2025',
            design: 'Estudio Bend',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Garcia Paredes 27',
        },
        {
            name: 'FENZZE',
            location: 'Madrid',
            images: [
                'images/social/fenzze/1.jpg',
            ],
            category: 'Arquitectura Gastronomica',
            area: '130 m²',
            year: '2025',
            design: 'Estudio Bend',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Castello 1',
        },
        {
            name: 'BRAZZA',
            location: 'Madrid',
            images: [
                'images/social/brazza/1.jpg',
            ],
            category: 'Arquitectura Gastronomica',
            area: '130 m²',
            year: '2025',
            design: 'Estudio Bend',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Garcia Paredes 27',
        },
        {
            name: 'JUANA LA LOCA',
            location: 'Madrid',
            images: [
                'images/social/juana/1.jpg',
                'images/social/juana/2.jpg',
                'images/social/juana/3.jpg',
                'images/social/juana/4.jpg',
                'images/social/juana/5.jpg',
                'images/social/juana/6.jpg',
                'images/social/juana/7.jpg',
                'images/social/juana/8.jpg',
                'images/social/juana/9.jpg',
                'images/social/juana/10.jpg',
                'images/social/juana/11.jpg',
                'images/social/juana/12.jpg',
            ],
            category: 'Arquitectura Gastronomica',
            area: '130 m²',
            year: '2025',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Recoletos 10'
        },
        {
            name: 'PIZZA TRAIN',
            location: 'Madrid',
            images: [
                'images/social/pizzatrain/1.jpg',
                'images/social/pizzatrain/2.jpg',
                'images/social/pizzatrain/3.jpg',
                'images/social/pizzatrain/4.jpg',
                'images/social/pizzatrain/5.jpg',
                'images/social/pizzatrain/6.jpg',
            ],
            category: 'Arquitectura Gastronomica',
            area: '130 m²',
            year: '2025',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Calle del Leon 3'
        },
        {
            name: 'LA VICCA',
            location: 'Madrid',
            images: [
                'images/social/lavicca/1.jpg',
                'images/social/lavicca/2.jpg',
                'images/social/lavicca/3.jpg',
                'images/social/lavicca/4.jpg',
                'images/social/lavicca/5.jpg',
                'images/social/lavicca/6.jpg',
                'images/social/lavicca/7.jpg',
                'images/social/lavicca/8.jpg',
                'images/social/lavicca/9.jpg',
                'images/social/lavicca/10.jpg',
                'images/social/lavicca/11.jpg',
                'images/social/lavicca/12.jpg',  
            ],
            category: 'Arquitectura Gastronomica',
            area: '130 m²',
            year: '2024',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Pablo Picasso 3'
        },
        {
            name: 'PARADA CERO',
            location: 'Madrid',
            images: [
                'images/social/paradacero/1.jpeg',
                'images/social/paradacero/2.jpeg',
                'images/social/paradacero/3.jpeg',
                'images/social/paradacero/4.HEIC',
                'images/social/paradacero/5.jpeg',
                'images/social/paradacero/6.jpeg',
            ],
            category: 'Arquitectura Gastronomica',
            area: '130 m²',
            year: '2024',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Pablo Picasso 4'
        }
    ],
    residential: [
        {
            name: 'C13',
            location: 'Madrid',
            images: [
                'images/residencial/c13/1.jpg',
            ],
            category: 'Arquitectura Residencial',
            area: '43 m²',
            year: '2025',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Castello 13',
        },
        {
            name: 'LT',
            location: 'Madrid',
            images: [
                'images/residencial/lt/1.jpg',
            ],
            category: 'Arquitectura Residencial',
            area: '85 m²',
            year: '2025',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'San Juan de Ortega 10',
        },
        {
            name: 'RB26',
            location: 'Madrid',
            images: [
                'images/residencial/rb26/1.jpg',
            ],
            category: 'Arquitectura Residencial',
            area: '36 m²',
            year: '2025',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Rufino Blanco 26'
        },
        {
            name: 'ALVEAR',
            location: 'Madrid',
            images: [
                'images/residencial/alvear/1.jpg',
                'images/residencial/alvear/2.jpg',
                'images/residencial/alvear/3.jpg',
                'images/residencial/alvear/4.jpg',
                'images/residencial/alvear/5.jpg',
                'images/residencial/alvear/6.jpg', 
                'images/residencial/alvear/7.jpg',
                'images/residencial/alvear/8.jpg',
                'images/residencial/alvear/9.jpg',
            ],
            category: 'Arquitectura Residencial',
            area: '240 m²',
            year: '2025',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Av Alvear 1491'
        },
        {
            name: 'ARTURO SORIA I',
            location: 'Madrid',
            images: [
                'images/residencial/asoria1/1.JPG',
                'images/residencial/asoria1/2.jpg',
                'images/residencial/asoria1/3.jpg',
                'images/residencial/asoria1/4.jpg',
                'images/residencial/asoria1/5.jpg',
                'images/residencial/asoria1/6.jpg',
            ],
            category: 'Arquitectura Residencial',
            area: '200 m²',
            year: '2023',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Lorenzo Solano Tendero 19'
        },
        {
            name: 'ARTURO SORIA II',
            location: 'Madrid',
            images: [
                'images/residencial/asoria2/1.jpg',
                'images/residencial/asoria2/2.jpg',
                'images/residencial/asoria2/3.jpg',
                'images/residencial/asoria2/4.jpg',
                'images/residencial/asoria2/5.jpg',
                'images/residencial/asoria2/6.jpg',
                'images/residencial/asoria2/7.jpg',
                'images/residencial/asoria2/8.jpg',
            ],
            category: 'Arquitectura Residencial',
            area: '110 m²',
            year: '2023',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Gran Via de Hortaleza 5'
        },
        {
            name: 'RGS',
            location: 'Madrid',
            images: [
                'images/residencial/rgs/1.jpg',
                'images/residencial/rgs/2.jpg',
                'images/residencial/rgs/3.jpg',
                'images/residencial/rgs/4.jpg',
                'images/residencial/rgs/5.jpg',
                'images/residencial/rgs/6.jpg',
                'images/residencial/rgs/8.jpg',
                'images/residencial/rgs/9.jpg',
            ],
            category: 'Arquitectura Residencial',
            area: '76 m²',
            year: '2024',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Ramon Gomez de la Serna 25'
        },
        {
            name: 'SANCHINARRO',
            location: 'Madrid',
            images: [
                'images/residencial/sanchinarro/1.jpg',
                'images/residencial/sanchinarro/2.jpg',
                'images/residencial/sanchinarro/3.jpg',
                'images/residencial/sanchinarro/4.jpg',
                'images/residencial/sanchinarro/5.jpg',
                'images/residencial/sanchinarro/6.jpg',
                'images/residencial/sanchinarro/7.jpg',
                'images/residencial/sanchinarro/8.jpg',
                'images/residencial/sanchinarro/9.jpg',
            ],
            category: 'Arquitectura Residencial',
            area: '160 m²',
            year: '2024',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Madrid',
            country: 'España',
            street: 'Ana de Austria 44'
        },
        {
            name: 'GUIDO',
            location: 'Buenos Aires',
            images: [
                'images/residencial/guido/1.jpg',
                'images/residencial/guido/2.jpg',
                'images/residencial/guido/3.jpg',
                'images/residencial/guido/4.jpg',
                'images/residencial/guido/5.jpg',
                'images/residencial/guido/6.HEIC',
                'images/residencial/guido/7.HEIC',
                'images/residencial/guido/8.HEIC',
                'images/residencial/guido/9.HEIC',
                'images/residencial/guido/10.jpg',
                'images/residencial/guido/11.jpg',
            ],
            category: 'Arquitectura Residencial',
            area: '160 m²',
            year: '2023',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Ciudad de Buenos Aires',
            country: 'Argentina',
            street: 'Guido 135'
        },
        {
            name: 'PALACIO ALCORTA',
            location: 'Buenos Aires',
            images: [
                'images/residencial/palcorta/1.JPG',
                'images/residencial/palcorta/2.JPG',
                'images/residencial/palcorta/3.JPG',
                'images/residencial/palcorta/4.JPG',
                'images/residencial/palcorta/5.JPG',
                'images/residencial/palcorta/6.JPG',
                'images/residencial/palcorta/7.JPG',
                'images/residencial/palcorta/8.JPG',
                'images/residencial/palcorta/9.JPG',
            ],
            category: 'Arquitectura Residencial',
            area: '130 m²',
            year: '2023',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Ciudad de Buenos Aires',
            country: 'Argentina',
            street: 'Guido'
        },
        {
            name: 'VIDT',
            location: 'Buenos Aires',
            images: [
                'images/residencial/vidt/1.JPG',
                'images/residencial/vidt/2.JPG',
                'images/residencial/vidt/3.JPG',
                'images/residencial/vidt/4.JPG',
                'images/residencial/vidt/5.JPG',
                'images/residencial/vidt/6.JPG',
            ],
            category: 'Arquitectura Residencial',
            area: '130 m²',
            year: '2022',
            design: 'Estudio IN SITU/',
            construction: 'Estudio IN SITU/',
            city: 'Ciudad de Buenos Aires',
            country: 'Argentina',
            street: 'Guido'
        }
    ]
};

let currentProjectSection = null;
let currentProjectIndex = 0;
let currentImageIndex = 0;
let modalInactivityTimer = null;
let lastScrollY = window.scrollY;

// ==================== WELCOME ANIMATION ====================
window.addEventListener('DOMContentLoaded', () => {
    const welcome = document.getElementById('welcome-screen');
    const logoAnim = document.getElementById('logo-anim');
    const sloganAnim = document.getElementById('slogan-anim');

    setTimeout(() => {
        logoAnim.classList.add('shifted');
        sloganAnim.classList.add('visible');
    }, 1000);

    setTimeout(() => {
        welcome.style.opacity = 0;
        setTimeout(() => {
            welcome.style.display = 'none';
        }, 1000);
    }, 3200);
    
    renderProjects('social');
    renderProjects('residential');
});

// ==================== MOBILE NAVIGATION ====================
const navToggle = document.getElementById('nav-toggle');
const navList = document.getElementById('nav-list');

navToggle.addEventListener('click', () => {
    navList.classList.toggle('show');
});

document.addEventListener('click', (e) => {
    if (window.innerWidth <= 700) {
        const nav = document.querySelector('nav');
        if (!nav.contains(e.target)) {
            navList.classList.remove('show');
        }
    }
});

// ==================== SECTION NAVIGATION ====================
const navLinks = document.querySelectorAll('nav a[data-section]');
const sections = document.querySelectorAll('.main-section');

navLinks.forEach(link => {
    link.addEventListener('click', (e) => {
        e.preventDefault();
        const section = link.dataset.section;
        
        navLinks.forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        
        sections.forEach(s => s.classList.remove('active'));
        document.getElementById(`section-${section}`).classList.add('active');
        
        navList.classList.remove('show');
    });
});

// ==================== HEADER SCROLL BEHAVIOR ====================
const header = document.querySelector('header');

window.addEventListener('scroll', () => {
    const currentScrollY = window.scrollY;
    
    if (currentScrollY > lastScrollY && currentScrollY > 100) {
        header.classList.add('hidden');
    } else {
        header.classList.remove('hidden');
    }
    
    lastScrollY = currentScrollY;
});

// ==================== PROJECT MODAL ====================
const modal = document.getElementById('project-modal');
const modalClose = document.getElementById('modal-close');
const modalInfo = document.getElementById('modal-info');
const modalTitle = document.getElementById('modal-title');
const modalText = document.getElementById('modal-text');
const modalImage = document.getElementById('modal-image');
const modalCounter = document.getElementById('modal-counter');
const modalPrev = document.getElementById('modal-prev');
const modalNext = document.getElementById('modal-next');
const nextProjectInfo = document.getElementById('next-project-info');
const nextProjectData = document.getElementById('next-project-data');

function openProjectModal(section, projectIndex) {
    currentProjectSection = section;
    currentProjectIndex = projectIndex;
    currentImageIndex = 0;
    
    updateModalContent();
    modal.classList.add('active');
    document.body.style.overflow = 'hidden';
    resetModalInactivity();
}

function closeProjectModal() {
    modal.classList.remove('active');
    document.body.style.overflow = '';
    clearTimeout(modalInactivityTimer);
}

function updateModalContent() {
    const project = projectsData[currentProjectSection][currentProjectIndex];
    const totalImages = project.images.length;
    const isLastImage = currentImageIndex === totalImages - 1;
    const hasNextProject = currentProjectIndex < projectsData[currentProjectSection].length - 1;
    const isFirstImage = currentImageIndex === 0;
    
    modalTitle.textContent = project.name;
    
    if (project.category) {
        modalText.innerHTML = `
            <div class="modal-text-item">
                <span class="modal-text-label">Categoria:</span>
                <span class="modal-text-value">${project.category}</span>
            </div>
            <div class="modal-text-item">
                <span class="modal-text-label">Area:</span>
                <span class="modal-text-value">${project.area}</span>
            </div>
            <div class="modal-text-item">
                <span class="modal-text-label">Año:</span>
                <span class="modal-text-value">${project.year}</span>
            </div>
            <div class="modal-text-item">
                <span class="modal-text-label">Diseño:</span>
                <span class="modal-text-value">${project.design}</span>
            </div>
            <div class="modal-text-item">
                <span class="modal-text-label">Construccion:</span>
                <span class="modal-text-value">${project.construction}</span>
            </div>
            <div class="modal-text-item">
                <span class="modal-text-label">Ciudad:</span>
                <span class="modal-text-value">${project.city}</span>
            </div>
            <div class="modal-text-item">
                <span class="modal-text-label">Pais:</span>
                <span class="modal-text-value">${project.country}</span>
            </div>
        `;
    } else {
        modalText.textContent = project.description || '';
    }
    
    modalImage.src = project.images[currentImageIndex];
    modalImage.alt = `${project.name} - Imagen ${currentImageIndex + 1}`;
    modalCounter.textContent = `${String(currentImageIndex + 1).padStart(2, '0')} — ${String(totalImages).padStart(2, '0')}`;
    
    if (isFirstImage) {
        modalInfo.classList.remove('hide-description');
    } else {
        modalInfo.classList.add('hide-description');
    }
    
    if (isLastImage && hasNextProject) {
        const nextProject = projectsData[currentProjectSection][currentProjectIndex + 1];
        nextProjectData.innerHTML = `
            <img src="${nextProject.images[0]}" alt="${nextProject.name}" class="next-project-thumbnail">
            <div class="next-project-title">${nextProject.name}</div>
        `;
        nextProjectInfo.dataset.canShow = 'true';
    } else {
        nextProjectInfo.dataset.canShow = 'false';
        nextProjectInfo.classList.remove('visible');
    }
    
    resetModalInactivity();
}

function navigateModalImage(direction) {
    const project = projectsData[currentProjectSection][currentProjectIndex];
    const totalImages = project.images.length;
    const isLastImage = currentImageIndex === totalImages - 1;
    const hasNextProject = currentProjectIndex < projectsData[currentProjectSection].length - 1;
    const hasPrevProject = currentProjectIndex > 0;
    
    if (direction === 'next') {
        if (isLastImage && hasNextProject) {
            currentProjectIndex++;
            currentImageIndex = 0;
        } else if (!isLastImage) {
            currentImageIndex++;
        }
    } else {
        if (currentImageIndex > 0) {
            currentImageIndex--;
        } else if (hasPrevProject) {
            currentProjectIndex--;
            currentImageIndex = projectsData[currentProjectSection][currentProjectIndex].images.length - 1;
        }
    }
    
    updateModalContent();
}

modalClose.addEventListener('click', (e) => {
    e.stopPropagation();
    closeProjectModal();
});

modalPrev.addEventListener('click', (e) => {
    e.stopPropagation();
    navigateModalImage('prev');
});

modalNext.addEventListener('click', (e) => {
    e.stopPropagation();
    navigateModalImage('next');
});

modalNext.addEventListener('mouseenter', () => {
    if (nextProjectInfo.dataset.canShow === 'true') {
        nextProjectInfo.classList.add('visible');
    }
});

modalNext.addEventListener('mouseleave', () => {
    nextProjectInfo.classList.remove('visible');
});

modal.addEventListener('click', (e) => {
    if (e.target === modal) {
        closeProjectModal();
    }
});

modal.addEventListener('mousemove', () => {
    if (modal.classList.contains('active')) {
        resetModalInactivity();
    }
});

// ==================== MODAL UI AUTO-HIDE ====================
const modalUIElements = [modalPrev, modalNext, modalCounter];

function hideModalUI() {
    modalUIElements.forEach(el => el.classList.add('hide-ui'));
}

function showModalUI() {
    modalUIElements.forEach(el => el.classList.remove('hide-ui'));
}

function resetModalInactivity() {
    showModalUI();
    clearTimeout(modalInactivityTimer);
    modalInactivityTimer = setTimeout(hideModalUI, 3000);
}

document.addEventListener('keydown', (e) => {
    if (modal.classList.contains('active')) {
        if (e.key === 'Escape') {
            closeProjectModal();
        } else if (e.key === 'ArrowLeft') {
            navigateModalImage('prev');
        } else if (e.key === 'ArrowRight') {
            navigateModalImage('next');
        }
        resetModalInactivity();
    }
});

// ==================== TOUCH SWIPE FOR MOBILE ====================
let touchStartX = 0;
let touchEndX = 0;

function handleSwipe() {
    if (touchEndX < touchStartX - 50) {
        navigateModalImage('next');
    }
    if (touchEndX > touchStartX + 50) {
        navigateModalImage('prev');
    }
}

modal.addEventListener('touchstart', (e) => {
    if (modal.classList.contains('active')) {
        touchStartX = e.changedTouches[0].screenX;
    }
}, false);

modal.addEventListener('touchend', (e) => {
    if (modal.classList.contains('active')) {
        touchEndX = e.changedTouches[0].screenX;
        handleSwipe();
    }
}, false);

// ==================== RENDER PROJECTS GRID ====================
function renderProjects(section) {
    const container = document.getElementById(`${section}-projects`);
    if (!container || !projectsData[section]) {
        return;
    }
    
    container.innerHTML = '';
    
    projectsData[section].forEach((project, index) => {
        const card = document.createElement('div');
        card.className = 'project-card';
        
        card.innerHTML = `
            <img src="${project.images[0]}" alt="${project.name}" class="project-image">
            <div class="project-info">
                <div class="project-name">${project.name}</div>
                <div class="project-location">${project.location}</div>
            </div>
        `;
        card.addEventListener('click', () => {
            openProjectModal(section, index);
        });
        container.appendChild(card);
    });
}

// ==================== GOOGLE MAPS ====================
window.initMap = function() {
    const mapCenter = { lat: 40.4168, lng: -3.7038 };
    
    const mapStyles = [
        {
            "elementType": "geometry",
            "stylers": [{"color": "#d4d4d4"}]
        },
        {
            "elementType": "labels.icon",
            "stylers": [{"visibility": "off"}]
        },
        {
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#424242"}]
        },
        {
            "elementType": "labels.text.stroke",
            "stylers": [{"color": "#d4d4d4"}]
        },
        {
            "featureType": "administrative.land_parcel",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#8a8a8a"}]
        },
        {
            "featureType": "poi",
            "elementType": "geometry",
            "stylers": [{"color": "#c8c8c8"}]
        },
        {
            "featureType": "poi",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#5a5a5a"}]
        },
        {
            "featureType": "poi.park",
            "elementType": "geometry",
            "stylers": [{"color": "#b8b8b8"}]
        },
        {
            "featureType": "poi.park",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#6a6a6a"}]
        },
        {
            "featureType": "road",
            "elementType": "geometry",
            "stylers": [{"color": "#e8e8e8"}]
        },
        {
            "featureType": "road.arterial",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#5a5a5a"}]
        },
        {
            "featureType": "road.highway",
            "elementType": "geometry",
            "stylers": [{"color": "#c0c0c0"}]
        },
        {
            "featureType": "road.highway",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#424242"}]
        },
        {
            "featureType": "road.local",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#6a6a6a"}]
        },
        {
            "featureType": "transit.line",
            "elementType": "geometry",
            "stylers": [{"color": "#b8b8b8"}]
        },
        {
            "featureType": "transit.station",
            "elementType": "geometry",
            "stylers": [{"color": "#c8c8c8"}]
        },
        {
            "featureType": "water",
            "elementType": "geometry",
            "stylers": [{"color": "#9a9a9a"}]
        },
        {
            "featureType": "water",
            "elementType": "labels.text.fill",
            "stylers": [{"color": "#6a6a6a"}]
        }
    ];
    
    const map = new google.maps.Map(document.getElementById('map'), {
        zoom: 12,
        center: mapCenter,
        styles: mapStyles,
        mapTypeControl: true,
        streetViewControl: true,
        fullscreenControl: true
    });
    
    const geocoder = new google.maps.Geocoder();
    const infoWindow = new google.maps.InfoWindow();
    const markers = [];
    
    // Recopilar todas las direcciones únicas de los proyectos
    const allProjects = [...projectsData.social, ...projectsData.residential];
    const uniqueAddresses = new Map();
    
    allProjects.forEach(project => {
        const address = `${project.street}, ${project.city}, ${project.country}`;
        // Encontrar el índice y sección del proyecto
        let projectSection = '';
        let projectIndex = -1;
        
        const socialIndex = projectsData.social.findIndex(p => p.name === project.name);
        if (socialIndex !== -1) {
            projectSection = 'social';
            projectIndex = socialIndex;
        } else {
            const residentialIndex = projectsData.residential.findIndex(p => p.name === project.name);
            if (residentialIndex !== -1) {
                projectSection = 'residential';
                projectIndex = residentialIndex;
            }
        }
        
        if (!uniqueAddresses.has(address)) {
            uniqueAddresses.set(address, []);
        }
        uniqueAddresses.get(address).push({
            ...project,
            section: projectSection,
            index: projectIndex
        });
    });
    
    // Crear marcadores para cada dirección única
    let markersCreated = 0;
    const totalAddresses = uniqueAddresses.size;
    
    uniqueAddresses.forEach((projects, address) => {
        geocoder.geocode({ address: address }, (results, status) => {
            if (status === 'OK') {
                const marker = new google.maps.Marker({
                    map: map,
                    position: results[0].geometry.location,
                    title: projects.map(p => p.name).join(', '),
                    animation: google.maps.Animation.DROP
                });
                
                markers.push(marker);
                
                // Si hay un solo proyecto en esta dirección, abrir modal directamente
                if (projects.length === 1) {
                    marker.addListener('click', () => {
                        const project = projects[0];
                        openProjectModal(project.section, project.index);
                    });
                } else {
                    // Si hay múltiples proyectos, mostrar InfoWindow con lista clickeable
                    let infoContent = `
                        <div style="padding: 12px; font-family: 'Helvetica', Arial, sans-serif; max-width: 280px;">
                            <div style="margin-bottom: 10px;">
                                <strong style="font-size: 0.85rem; color: #666; text-transform: uppercase; letter-spacing: 0.5px;">
                                    ${projects[0].street}
                                </strong>
                            </div>
                    `;
                    
                    projects.forEach(project => {
                        infoContent += `
                            <div class="map-project-item" data-section="${project.section}" data-index="${project.index}" style="margin-bottom: 8px; padding: 8px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s;">
                                <h3 style="margin: 0 0 4px 0; font-size: 1.1rem; color: #222; font-weight: 700;">
                                    ${project.name}
                                </h3>
                                <p style="margin: 0; font-size: 0.85rem; color: #666;">
                                    ${project.category}
                                </p>
                                <p style="margin: 4px 0 0 0; font-size: 0.8rem; color: #999;">
                                    ${project.area} • ${project.year}
                                </p>
                            </div>
                        `;
                    });
                    
                    infoContent += `
                            <style>
                                .map-project-item:hover {
                                    background: #f5f5f5;
                                    border-radius: 4px;
                                }
                            </style>
                        </div>
                    `;
                    
                    marker.addListener('click', () => {
                        infoWindow.setContent(infoContent);
                        infoWindow.open(map, marker);
                        
                        // Esperar a que el InfoWindow se renderice para agregar event listeners
                        google.maps.event.addListenerOnce(infoWindow, 'domready', () => {
                            const projectItems = document.querySelectorAll('.map-project-item');
                            projectItems.forEach(item => {
                                item.addEventListener('click', () => {
                                    const section = item.getAttribute('data-section');
                                    const index = parseInt(item.getAttribute('data-index'));
                                    infoWindow.close();
                                    openProjectModal(section, index);
                                });
                            });
                        });
                    });
                }
                
                markersCreated++;
                
                // Cuando todos los marcadores estén creados, crear el cluster y ajustar bounds
                if (markersCreated === totalAddresses) {
                    // Crear el MarkerClusterer con configuración personalizada
                    new markerClusterer.MarkerClusterer({
                        map,
                        markers,
                        algorithm: new markerClusterer.SuperClusterAlgorithm({ radius: 100 }),
                        renderer: {
                            render: ({ count, position }) => {
                                // Estilo personalizado para los clusters
                                const svg = `
                                    <svg width="50" height="50" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="25" cy="25" r="22" fill="#222" fill-opacity="0.9"/>
                                        <circle cx="25" cy="25" r="22" fill="none" stroke="#fff" stroke-width="2"/>
                                        <text x="25" y="30" text-anchor="middle" font-family="Helvetica, Arial, sans-serif" font-size="14" font-weight="700" fill="#fff">${count}</text>
                                    </svg>
                                `;
                                
                                return new google.maps.Marker({
                                    position,
                                    icon: {
                                        url: `data:image/svg+xml;base64,${btoa(svg)}`,
                                        scaledSize: new google.maps.Size(50, 50),
                                    },
                                    label: {
                                        text: String(count),
                                        color: "transparent",
                                    },
                                    zIndex: 1000 + count,
                                });
                            },
                        },
                    });
                    
                    // Ajustar el mapa para mostrar todos los marcadores
                    const bounds = new google.maps.LatLngBounds();
                    markers.forEach(marker => {
                        bounds.extend(marker.getPosition());
                    });
                    map.fitBounds(bounds);
                }
            } else {
                console.warn('Geocoding falló para: ' + address + ' Razón: ' + status);
            }
        });
    });
};